const FAQ_DATA = {
  "items": [
    {"id":"about-1","type":"qa","category":"About","question":"Who is Digital Factory and what do they do?","answer":"Digital Factory Technologies, Inc. is a Chicago-based mobile ad-tech and data-analytics company that builds patented location technologies (MicroFencing™, Dwell™, Present™) to deliver accurate, real-world mobile engagement and analytics for brands and apps.","source_url":"dgtl-factory.com"},
    {"id":"about-2","type":"qa","category":"About","question":"Where is Digital Factory located and how do I contact them?","answer":"Head office: 303 East Wacker Drive, Chicago, Illinois 60605. Public contact emails include sales-info@dgtl-factory.com, contact@dgtl-factory.com, and info@dgtl-factory.com as listed in the privacy policy.","source_url":"dgtl-factory.com"},
    {"id":"about-3","type":"qa","category":"About","question":"Does Digital Factory hold patents?","answer":"Yes. The company publicly marks MicroFencing™, Dwell™, Present™ and lists U.S. patents (for example U.S. Patent No. 10,163,110 and U.S. Patent No. 11,044,572) and related patent abstracts.","source_url":"dgtl-factory.com"},
    {"id":"tech-1","type":"qa","category":"Technologies","question":"What is MicroFencing™?","answer":"MicroFencing™ is Digital Factory’s high-accuracy geofencing technology designed to place very small, precision virtual fences (from street corners to whole cities) that trigger contextual mobile messages and analytics when a device crosses or dwells in those areas.","source_url":"dgtl-factory.com"},
    {"id":"tech-2","type":"qa","category":"Technologies","question":"What is Dwell™ and how is it used?","answer":"Dwell™ measures how long a user remains at a location (dwell time) and combines that with other attributes to improve audience profiles, conversion probability scoring, and analytics used by campaigns or apps.","source_url":"dgtl-factory.com"},
    {"id":"tech-3","type":"qa","category":"Technologies","question":"What is Present™ (if referenced)?","answer":"Present™ is a named tool in Digital Factory’s patent marking list; it is presented alongside MicroFencing™ and Dwell™ as part of the company’s suite of location-engagement products.","source_url":"dgtl-factory.com"},
    {"id":"tech-4","type":"qa","category":"Technologies","question":"Are these technologies integrated into client apps or standalone apps?","answer":"Digital Factory’s solutions can be integrated into a client’s native application or delivered through custom applications built for clients. Data ownership and primary terms depend on the client agreement; Digital Factory states clients generally own their program data.","source_url":"dgtl-factory.com"},
    {"id":"usecases-1","type":"qa","category":"Use Cases","question":"Which industries does Digital Factory serve?","answer":"Examples include automotive, entertainment/live events, healthcare, gaming, media/publishing, and retail/brands demonstrated through case studies with partners like Ford, Live Nation UK, CVS Health, Touchjet, Snack Media, Leo Burnett, etc.","source_url":"dgtl-factory.com"},
    {"id":"usecases-2","type":"qa","category":"Use Cases","question":"What outcomes have customers achieved?","answer":"Case-study examples show results like a 60% increase in test-drive engagement for Ford during an event; large impression volumes for Live Nation UK and measurable conversion and engagement improvements for other clients. Specific numbers are shown in respective case studies.","source_url":"dgtl-factory.com"},
    {"id":"metrics-1","type":"qa","category":"Metrics","question":"How does Digital Factory measure campaign success?","answer":"Success metrics include notifications delivered, conversation/engagement rates, conversion increases, impressions, dwell time and saved costs; the technology uses real-time dashboards and analytics.","source_url":"dgtl-factory.com"},
    {"id":"privacy-1","type":"qa","category":"Privacy & Data","question":"What user data does Digital Factory collect?","answer":"Digital Factory may collect location data and, depending on client programs, some additional external/system-level data (weather, travel patterns). They state they do not collect financial or medical sensitive types directly and report analytics in aggregate. Collection is subject to client program choices.","source_url":"dgtl-factory.com"},
    {"id":"privacy-2","type":"qa","category":"Privacy & Data","question":"Does Digital Factory sell personal data?","answer":"The privacy policy states Digital Factory does not sell personal information and does not sell/rent/lease customer or user lists to third parties.","source_url":"dgtl-factory.com"},
    {"id":"privacy-3","type":"qa","category":"Privacy & Data","question":"Who owns the data collected through programs?","answer":"The client (program sponsor) generally owns the data from their end users; Digital Factory acts as the service provider and processes data per the client’s program and terms. End users are advised to review the client’s privacy terms.","source_url":"dgtl-factory.com"},
    {"id":"security-1","type":"qa","category":"Privacy & Data","question":"What security measures are described?","answer":"The privacy policy describes technical, physical and organizational security controls and mentions SSL; it acknowledges internet transmission risks and limits absolute guarantees. For custom apps, Digital Factory references “military-grade security” in case studies for healthcare solutions.","source_url":"dgtl-factory.com"},
    {"id":"privacy-4","type":"qa","category":"Privacy & Data","question":"How can users request deletion of their data?","answer":"The privacy policy describes a “Right to Deletion” process: Digital Factory will delete personally identifiable information on receipt of a verifiable request, subject to legal and operational exceptions (e.g., fraud detection, debugging, legal obligations). Contact details are provided in the privacy policy.","source_url":"dgtl-factory.com"},
    {"id":"integration-1","type":"qa","category":"Implementation","question":"How do I integrate Digital Factory into my mobile app?","answer":"Implementation usually involves SDK or integration work to gather location signals, configure micro-fences, and route analytics to a dashboard; specifics are contractual and handled by Digital Factory’s sales/implementation teams.","source_url":"dgtl-factory.com"},
    {"id":"integration-2","type":"qa","category":"Implementation","question":"Is there an API or SDK publicly documented?","answer":"The public website highlights integrations and dashboarding but does not publish public API/SDK docs on the marketing pages; request developer/API details directly from the sales or technical contact listed on the site.","source_url":"dgtl-factory.com"},
    {"id":"onboarding-1","type":"qa","category":"Implementation","question":"What is the typical onboarding process and timeline?","answer":"The site emphasizes custom engagement and data-driven implementation; it does not publish a fixed timeline. Onboarding depends on app access, SDK integration, micro-fence design, and campaign goals — estimate and schedule are provided per client onboarding conversation.","source_url":"dgtl-factory.com"},
    {"id":"pricing-1","type":"qa","category":"Pricing & Contracts","question":"How much does Digital Factory charge?","answer":"Pricing is not published on the public site. Procurement and pricing are handled through sales contracts tailored to campaign scope, integration complexity, and data services. Contact sales-info@dgtl-factory.com for quotes.","source_url":"dgtl-factory.com"},
    {"id":"pricing-2","type":"qa","category":"Pricing & Contracts","question":"What licensing or contract model is used?","answer":"The site implies enterprise/client contracts that include terms, privacy agreements and data ownership clauses. Clients typically sign program-specific Terms of Use; Digital Factory references that client terms govern end-user experience when integrated in client apps.","source_url":"dgtl-factory.com"},
    {"id":"patents-1","type":"qa","category":"Legal & Patents","question":"Which patents cover Digital Factory solutions?","answer":"The company lists U.S. patents including No. 10,163,110 and No. 11,044,572, and notes MicroFencing™, Dwell™, Present™ may be covered by one or more patents.","source_url":"dgtl-factory.com"},
    {"id":"legal-1","type":"qa","category":"Legal & Patents","question":"What governing law applies?","answer":"The privacy policy and terms indicate governing law is the State of Illinois for their Terms of Use and web products, and the site references compliance with CCPA requirements where applicable.","source_url":"dgtl-factory.com"},
    {"id":"cases-1","type":"qa","category":"Case Studies","question":"Can you list notable clients and results?","answer":"Public case studies cite Ford (60% increase in test-drive engagement in a 3-day event), Live Nation UK (6.8M+ impressions in London), CVS Health (identified cost reductions and digital adoption lift), Touchjet, Snack Media, Leo Burnett, and others. Exact figures are shown in the case studies.","source_url":"dgtl-factory.com"},
    {"id":"cases-2","type":"qa","category":"Case Studies","question":"Are full case studies publicly available?","answer":"The site shows summaries and asks users to sign up to see full case studies. Contact sales to request complete case study documents.","source_url":"dgtl-factory.com"},
    {"id":"support-1","type":"qa","category":"Support","question":"How do I get technical support?","answer":"Use listed contact emails or the support channel indicated on the site. For legal/privacy issues use info@dgtl-factory.com or the General Counsel number listed in the privacy policy.","source_url":"dgtl-factory.com"},
    {"id":"support-2","type":"qa","category":"Support","question":"What operational logs and diagnostics are available?","answer":"The privacy policy references Systems Operations Data (logs, event files, diagnostics) used to operate and maintain services. These are recorded as part of service operation and subject to client agreement.","source_url":"dgtl-factory.com"},
    {"id":"enduser-1","type":"qa","category":"End-User Privacy","question":"I’m an app user — how is my location used?","answer":"If a client’s app includes Digital Factory technology, location is collected to provide the app’s features (notifications, relevant content). Data use is subject to the client’s privacy terms and Digital Factory’s privacy policy; users must review their program sponsor’s terms and any in-app consent flows.","source_url":"dgtl-factory.com"},
    {"id":"enduser-2","type":"qa","category":"End-User Privacy","question":"Can I opt out of location tracking?","answer":"Opt-out depends on the client app and platform settings. The privacy page instructs users to consult the program sponsor’s terms and app settings; end users can manage permissions via their device settings and request deletion as per the Right to Deletion procedure.","source_url":"dgtl-factory.com"},
    {"id":"marketing-1","type":"qa","category":"Marketing","question":"What’s the difference between geofencing and micro-fencing?","answer":"Geofencing is broad virtual boundaries; micro-fencing denotes much higher spatial precision (street corner granularity) plus dwell-time and richer behavior signals for better targeting and analytics.","source_url":"dgtl-factory.com"},
    {"id":"marketing-2","type":"qa","category":"Marketing","question":"What metrics should I expect to track?","answer":"Impressions, notifications delivered, dwell time, engagement/conversation rate, conversion probability, app behavior before/after a fence event, and campaign ROI are standard metrics showcased in case studies.","source_url":"dgtl-factory.com"},
    {"id":"marketing-3","type":"qa","category":"Marketing","question":"Is this solution suitable for small businesses?","answer":"The site highlights enterprise and campaign-level case studies; approach sales to discuss scaled or pilot options. No small-business pricing is published publicly.","source_url":"dgtl-factory.com"},
    {"id":"sales-1","type":"qa","category":"Sales","question":"Request a demo, pricing, or technical documentation.","answer":"Route to sales-info@dgtl-factory.com or contact@dgtl-factory.com and specify: business name, app/platform, use case, expected geo scope, estimated monthly active users, and desired KPIs.","source_url":"dgtl-factory.com"},
    {"id":"sales-2","type":"qa","category":"Sales","question":"Ask for security/compliance whitepaper or SOC/ISO certifications.","answer":"Digital Factory does not publish SOC/ISO documents publicly on marketing pages; request security/compliance documentation via sales or legal contacts.","source_url":"dgtl-factory.com"},
    {"id":"edgecases-1","type":"qa","category":"Edge Cases","question":"What happens to data if a client ends service?","answer":"Data retention and deletion follow the client contract and policy; Digital Factory’s privacy policy outlines the Right to Deletion and exceptions for legal/operational needs. Escalate to legal for contract-specific details.","source_url":"dgtl-factory.com"},
    {"id":"edgecases-2","type":"qa","category":"Edge Cases","question":"Does Digital Factory work internationally?","answer":"Case studies reference global campaigns (e.g., UK Live Nation), indicating international operations; legal terms reference U.S. governing law. Confirm international support and data residency during procurement.","source_url":"dgtl-factory.com"},
    {"id":"edgecases-3","type":"qa","category":"Edge Cases","question":"Can Digital Factory target inside venues (indoor micro-fences)?","answer":"The technology claims high-precision micro-fencing and dwell analytics; site examples include event venues and entrances. Indoor feasibility depends on signal availability and integration approach.","source_url":"dgtl-factory.com"}
  ]
};

// ----Our Utilities Block----
const STOP = new Set(["the","is","are","a","an","and","or","to","of","do","does","what","how","who","where","when","why","with","for","on","in","into","about","can","i","we","you","it"]);
function keywordsFromQuestion(q) {
  return q.toLowerCase().replace(/[^a-z0-9\s-]/g, " ")
    .split(/\s+/)
    .filter(w => w && !STOP.has(w) && w.length >= 4);
}

function prepFaq(rawItems) {
  // Only take type==qa
  const qa = rawItems.filter(x => x.type === 'qa');
  return qa.map(x => ({
    id: x.id,
    category: x.category || 'General',
    question: x.question,
    answer: x.answer,
    source: x.source_url || '',
    // auto keywords from question + special hyphen variations for common terms(this is where it matches keyword)
    keywords: [
      ...keywordsFromQuestion(x.question || ''),
    ]
  }));
}

function scoreMatch(text, faq) {
  let score = 0;
  for (const kw of faq.keywords) {
    if (!kw) continue;
    if (text.includes(kw)) score += 2; // direct match
    // hyphen variations (e.g., microfencing vs micro-fencing)
    const alt = kw.replace(/-/g, "");
    if (alt !== kw && text.replace(/-/g, "").includes(alt)) score += 1;
  }
  // light bonus if any word from the original question appears
  const qwords = keywordsFromQuestion(faq.question || '');
  for (const w of qwords) if (text.includes(w)) score += 0.5;
  return score;
}

function findBest(text, faqs) {
  const t = text.toLowerCase();
  let best = null, bestScore = 0;
  for (const f of faqs) {
    const s = scoreMatch(t, f);
    if (s > bestScore) { best = f; bestScore = s; }
  }
  return (bestScore > 0 ? best : null);
}

function topCategories(faqs) {
  const byCat = new Map();
  for (const f of faqs) {
    if (!byCat.has(f.category)) byCat.set(f.category, []);
    byCat.get(f.category).push(f);
  }
  // return up to 6 chips (first item of each category)
  const chips = [];
  for (const [cat, list] of byCat) {
    chips.push({ label: cat, sample: list[0]?.question || '' });
    if (chips.length >= 6) break;
  }
  return chips;
}

// ---- Load embedded JSON and Pranjay's FAQ ----
// const raw = JSON.parse(document.getElementById('faq-json').textContent);
const FAQ = prepFaq(FAQ_DATA.items || FAQ_DATA || []);

// ---- just basic UI wiring ----
const q = document.getElementById('q');
const ask = document.getElementById('ask');
const bd = document.getElementById('bd');
const md = document.getElementById('md');
const mbody = document.getElementById('mbody');
const msource = document.getElementById('msource');
const close = document.getElementById('close');
const topics = document.getElementById('topics');

// chips for fast prompts
const chips = topCategories(FAQ);
for (const c of chips) {
  const el = document.createElement('button');
  el.className = 'chip';
  el.textContent = c.label;
  el.title = c.sample;
  el.addEventListener('click', () => { q.value = c.sample || ("Tell me about " + c.label); q.focus(); });
  topics.appendChild(el);
}

function openModal(text, src) {
  mbody.textContent = text;
  msource.textContent = src ? `Source: ${src}` : '';
  md.style.display = 'block';
  bd.style.display = 'block';
}
function closeModal() {
  md.style.display = 'none';
  bd.style.display = 'none';
}
close.addEventListener('click', closeModal);
bd.addEventListener('click', closeModal);

function onAsk() {
  const msg = (q.value || '').trim();
  if (!msg) return;
  const match = findBest(msg, FAQ);
  if (match) {
    console.log('[DF-FAQ]', new Date().toISOString(), { question: msg, intent_id: match.id, category: match.category });
    openModal(match.answer, match.source);
  } else {
    // suggest up to 3 example questions(we can add some more if we needed)
    const suggestions = FAQ.slice(0,3).map(f => `• ${f.question}`).join("\n");
    const fallback = "I’m not sure about that yet. Here are some things I can help with:\n\n" + suggestions;
    console.log('[DF-FAQ]', new Date().toISOString(), { question: msg, intent_id: null });
    openModal(fallback, '');
  }
}

ask.addEventListener('click', onAsk);
q.addEventListener('keydown', (e) => { if (e.key === 'Enter') onAsk(); });
